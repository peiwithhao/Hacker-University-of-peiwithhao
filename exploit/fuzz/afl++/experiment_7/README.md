## environment
OS: ubuntu20.04LTS
afl++: latest  
VLC: 3.0.7.1

## 部分插桩
[官方文档](https://github.com/AFLplusplus/AFLplusplus/blob/stable/instrumentation/README.instrument_list.md)
当我们在测试大型项目的时候,可能因为功能的多样性导致模糊测试效率十分低下，从而在不断变异升级模糊测试的过程中反而导致产生许多afl++
认为有趣的变异但对于正在测试的目的相差甚远，因此这里有一种部分插桩的方法可以用来将覆盖率的记录和返回限制在几个你所指定的程序当中

简单来讲也就是对模糊测试的过程进行一个规则的约束，使得他能更有针对性的fuzz
我们可以查看[官网信息](https://github.com/AFLplusplus/AFLplusplus/blob/stable/instrumentation/README.instrument_list.md)来进一步获取相关知识:

部分插桩有两种实现办法，下面分别叙述

### 部分覆盖率检测




使用守则表明我们需要先找到希望fuzz的源代码,然后在头文件后面添加下面的宏
```c
#include <stdio.h>
#include <stdint.h>
// ...

__AFL_COVERAGE();  // <- required for this feature to work
```

然后如果你希望在指定的位置开启覆盖率支持,
同时在指定的位置关闭覆盖率支持，可以添加下面这段宏

```c
__AFL_COVERAGE_START_OF();
```

在添加完毕之后就可以使用下面几种宏，其分别代表的含义是:
+ `__AFL_COVERAGE_ON()`: 覆盖率开始记录
+ `__AFL_COVERAGE_OFF()`: 从这里开始禁用覆盖率
+ `__AFL_COVERAGE_DISCARD()`: 重置前面的所有覆盖率
+ `__AFL_COVERAGE_SKIP()`: 将此测试用例标记为不重要


### 部分文件/函数检测

> [!important]
> 这里进行部分程序插桩的方法主要是设置环境变量白名单`AFL_LLVM_ALLOWLIST`或设置黑名单`AFL_LLVM_DENYLIST`,然后带上文件名
> GCC-PLUGIN则使用`AFL_GCC_ALLOWLIST/AFL_LLVM_DENYLIST`

这里需要使用`afl-clang-fast/afl-clang-fast++` 和 `afl-clang-lto/afl-clang-lto++`编译才行

为了匹配成功,这里文件的每一行都需要以测试的文件/函数为结尾,用来防止路径的解析错误

> [!note]
> 如果是启用了优化编译， 函数可能变成内联, 并且会不匹配


 如果你的项目源码格式如下：
```text
project/
project/feature_a/a1.cpp
project/feature_a/a2.cpp
project/feature_b/b1.cpp
project/feature_b/b2.cpp
```

如果我想仅仅测试两个文件a1.cpp和b2.cpp,可以创建如下的instrument file list
```text
feature_a/a1.cpp
feature_b/b2.cpp
```




而这个部分插桩也不仅限于文件，同样可以设置函数极的插桩，格式如下：
```text
src: *malloc.c
fun: MallocFoo         
```

> [!caution]
> C++项目的函数名称需要额外注意，可以使用`nm`来打印函数名称

这个文件支持注释



## 编译VLC
先设置环境变量
```sh
export CC=afl-clang-lto
export CXX=afl-clang-lto++
export AFL_USE_ASAN=1
```

CVE


然后下载对应版本VLC

```sh
wget https://download.videolan.org/pub/vlc/3.0.7.1/vlc-3.0.7.1.tar.xz
```
因为是部分插桩，所以我们需要简单看看漏洞报告需要哪些地方(虽然有从答案开始讲的嫌疑)

查看[NVD网站](https://nvd.nist.gov/vuln/detail/CVE-2019-14776) 
> [!note]
> A heap-based buffer over-read exists in DemuxInit() in demux/asf/asf.c in VideoLAN VLC media player 3.0.7.1 via a crafted .mkv file.

发现越界读在`asf.c`,那么我们可以直接写一下自己的instrument list

```sh
peiwithhao@peiwithhao-Standard-PC-Q35-ICH9-2009:~/vlc-3.0.7.1$ find . | grep asf
./modules/demux/asf
./modules/demux/asf/asfpacket.c
./modules/demux/asf/libasf.c
./modules/demux/asf/libasf_guid.h
./modules/demux/asf/asfpacket.h
./modules/demux/asf/asf.c
./modules/demux/asf/libasf.h
./modules/mux/asf.c
./modules/codec/wmafixed/asf.h
./modules/access/mms/asf.h
./modules/access/mms/asf.c
```
发现在模块目录下，那么我们可以思考一下如何写入,我这里自己考虑将所有demux的文件夹写入

```instrument
modules/demux/asf/asfpacket.c
modules/demux/asf/libasf.c
modules/demux/asf/asf.c
```

首先进行正常编译,注意其可能需要一系列包这里就不列出了，就根据configure的提示来慢慢安装就行

```sh
./configure --prefix=$(pwd)/install --disable-lua --disable-avcodec --disable-swscale --disable-a52 --enable-xcb=false --disable-alsa
make -j$(nproc)
make install
```


# 参考
[https://github.com/AFLplusplus/AFLplusplus/blob/stable/instrumentation/README.instrument_list.md](https://github.com/AFLplusplus/AFLplusplus/blob/stable/instrumentation/README.instrument_list.md)


