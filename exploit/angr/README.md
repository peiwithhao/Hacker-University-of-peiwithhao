<!--toc:start-->
- [angr入门学习](#angr入门学习)
- [安装](#安装)
  - [恢复控制流图](#恢复控制流图)
  - [控制流图可视化](#控制流图可视化)
- [基本使用](#基本使用)
  - [基本属性](#基本属性)
  - [基本变量](#基本变量)
  - [加载](#加载)
  - [factory](#factory)
    - [Blocks](#blocks)
    - [States](#states)
    - [Simulation Managers](#simulation-managers)
    - [Analyses](#analyses)
- [参考](#参考)
<!--toc:end-->

# angr入门学习
简单介绍, angr是一个二进制分析工具，但是其中最亮眼的工作是对符号执行的应用

# 安装
```sh
pip3 install angr  //这里建议自己构造一个py环境来运行
```

其中官网给出了几个例子


## 恢复控制流图
```py
>>> import angr
>>> proj = angr.Project('./fauxware')
>>> cfg = proj.analyses.CFG()
>>> dict(proj.kb.functions)
{4195552L: <Function _init (0x4004e0)>,
 4195600L: <Function plt.puts (0x400510)>,
 4195616L: <Function plt.printf (0x400520)>,
 4195632L: <Function plt.read (0x400530)>,
 4195648L: <Function plt.__libc_start_main (0x400540)>,
 4195664L: <Function plt.strcmp (0x400550)>,
 4195680L: <Function plt.open (0x400560)>,
 4195696L: <Function plt.exit (0x400570)>,
 4195712L: <Function _start (0x400580)>,
 4195756L: <Function call_gmon_start (0x4005ac)>,
 4195904L: <Function frame_dummy (0x400640)>,
 4195940L: <Function authenticate (0x400664)>,
 4196077L: <Function accepted (0x4006ed)>,
 4196093L: <Function rejected (0x4006fd)>,
 4196125L: <Function main (0x40071d)>,
 4196320L: <Function __libc_csu_init (0x4007e0)>,
 4196480L: <Function __do_global_ctors_aux (0x400880)>}
```

## 控制流图可视化
这一部分参考[https://fgroove.github.io/2019/07/03/angr.analyses.CFG/](https://fgroove.github.io/2019/07/03/angr.analyses.CFG/)

> [!Tip]
> 需要安装`angr-utils`

```sh
cd angr-dev
git clone https://github.com/axt/bingraphvis
pip install -e ./bingraphvis
git clone https://github.com/axt/angr-utils
pip install -e ./angr-utils
```


安装过后就拥有令人可视化的图片功能

```py
import angr
from angrutils import *
proj = angr.Project('./test', load_options={'auto_load_libs':False})

# 快速生成
cfg = proj.analyses.CFGFast()
# 精确生成
cfg1 = proj.analyses.CFGEmulated()

plot_cfg(cfg, "test", asminst=True, remove_imports=True, remove_path_terminator=True)
```


# 基本使用
首先使用angr来分析静态代码，首先需要将其加载，其[官方文档](https://docs.angr.io/en/latest/core-concepts/toplevel.html)提供了下面的例子

## 基本属性
```py
import angr
project = angr.Project('./test')
```
依靠他我们才能进行接下来的工作

## 基本变量

```py
project.arch
project.entry
project.filename
```

得出结果如下:
```sh
<Arch AMD64 (LE)>
0x402d40
./test
```
## 加载
将二进制代码加载到内存当中
```py
print(proj.loader)
print(proj.loader.shared_objects)  #加载共享库
print(hex(proj.loader.min_addr))    # 最小地址
print(hex(proj.loader.max_addr))    # 最大地址
print(proj.loader.main_object)      # main函数所在的基地址
print(proj.loader.main_object.execstack) #是否有可执行栈
print(proj.loader.main_object.pic)      # 是否是二进制位置无关
```

## factory
让你能更加丝滑的使用一些常用object

### Blocks
这里指的是代码块
```py
block = proj.factory.block(proj.entry)
print(block)
print(block.pp())
```
这行代码主要是获取proj入口处的代码块,和代码块内的二进制指令
```sh
<Block for 0x401060, 37 bytes>
        _start:
401060  endbr64 
401064  xor     ebp, ebp
401066  mov     r9, rdx
401069  pop     rsi
40106a  mov     rdx, rsp
40106d  and     rsp, 0xfffffffffffffff0
401071  push    rax
401072  push    rsp
401073  xor     r8d, r8d
401076  xor     ecx, ecx
401078  lea     rdi, [main]
40107f  call    qword ptr [0x403fc0]
None
```

除此之外他还可以获取指令条数,和指令的地址
```py
print("instructions number:", block.instructions)
print("instructions number:", block.instruction_addrs)
```
```sh
instructions number: 12
instructions number: (4198496, 4198500, 4198502, 4198505, 4198506, 4198509, 4198513, 4198514, 4198515, 4198518, 4198520, 4198527)
```


### States
> [!important]
> project仅仅只代表了程序的初始化镜像,当你想使用angr执行程序的时候
> 你需要使用额外的结构`SimState`,他的获取如下

```py
state = proj.factory.entry_state()
```
我们对于state这个object可以使用的字段有如下:
```py
state.regs.rip
state.regs.rax          # 获取寄存器的rax
state.mem[proj.etnry].int.resolved #将指定地址作为c int来进行解析
```

### Simulation Managers
一个state代表了一个程序在指定时间的状态，
simulation manager是angr中对于执行程序的主要接口
要使用他就需要先创建一个`simulation_manager`
```py
simgr = proj.factory.simulation_manager(state)
```
接下来就是运行程序
```py
simgr.step()
simgr.active
```

### Analyses
没有过多介绍，这里是提供了许多有趣的工具,可以通过`proj.analyese.`然后按TAB来查看有哪些帮助工具

# 参考
[https://fgroove.github.io/2019/07/03/angr.analyses.CFG/](https://fgroove.github.io/2019/07/03/angr.analyses.CFG/)
[https://github.com/axt/angr-utils](https://github.com/axt/angr-utils)
[https://docs.angr.io/en/latest/core-concepts/toplevel.html](https://docs.angr.io/en/latest/core-concepts/toplevel.html)
