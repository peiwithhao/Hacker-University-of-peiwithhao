#define _GNU_SOURCE
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <sched.h>
#include <error.h>
#include <unistd.h>
#include <net/if.h>
#include <ifaddrs.h>

#include "setup.h"
#include "file.h"
#include "nftnl.h"
#define PATH_MAX 1024


static void do_unshare(void){
    int ret;

    printf("[+] Create new user namespace...\n");
    // move into user namespace
    ret = unshare(CLONE_NEWUSER);
    if(ret == -1){
        perror("[x] Create new user namespace failed...");
        exit(1);
    }

    printf("[+] Create new net namespace...\n");
    ret = unshare(CLONE_NEWNET);
    if(ret == -1){
        perror("[x] Create new net namespace failed...");
        exit(1);
    }
}

static void configure_uid_map(uid_t old_uid, gid_t old_gid){
    char uid_map[128];
    char gid_map[128];

    printf("[+] setting up UID namespace...\n");
    // new namespace uid 0 mapped to new namespace uid n
    sprintf(uid_map, "0 %d 1\n", old_uid);
    // same as above
    sprintf(gid_map, "0 %d 1\n", old_gid);
    write_file("/proc/self/uid_map", uid_map, strlen(uid_map));
    // protected from setgroups()
    write_file("/proc/self/setgroups", "deny", strlen("deny"));
    write_file("/proc/self/gid_map", gid_map, strlen(gid_map));

    system("id");

}

static void disable_rpf_by_ifname(const char *ifname)
{
    char rp_filter_path[PATH_MAX];

    printf("[*] disabling rpf for interface: '%s'\n", ifname);

    sprintf(rp_filter_path, "/proc/sys/net/ipv4/conf/%s/rp_filter", ifname);

    write_file(rp_filter_path, "0\n", 2);
}

static void disable_rpf_for_all()
{
    struct ifaddrs *addrs;

    getifaddrs(&addrs);

    for (struct ifaddrs *curr = addrs; curr != NULL; curr = curr->ifa_next)
        if (curr->ifa_addr && curr->ifa_addr->sa_family == AF_PACKET)
            disable_rpf_by_ifname(curr->ifa_name);

    freeifaddrs(addrs);
}
static void configure_net_interfaces(){
    printf("[+] configureing localhost in namespace...\n");
    //bring lo up
    //kernel ctf has no ip commnad ,but i have
    disable_rpf_for_all();
	write_file("/proc/sys/net/ipv4/conf/all/rp_filter", "0\n", 2);
    system("ip link set lo up");
    system("ip addr");
    system("sysctl net.ipv4.conf.all.rp_filter");
    system("sysctl net.ipv4.conf.lo.rp_filter");
}




void do_setup(void){
    uid_t uid = getuid();
    gid_t pid = getgid();
    //Create user && net namespace
    do_unshare();
    //configure uid map
    configure_uid_map(uid, pid);
    configure_net_interfaces();
    configure_nftables();


    // nftables_setup();
    // do_configure_uidmap();
}
